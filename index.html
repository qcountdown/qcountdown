<html lang="en">
<html>

<head>
    <title>Timers</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charSet="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="HTML, CSS, JavaScript">
    <!-- <link rel="stylesheet" type="text/css" href="milligram.css"> -->
    <style>
        *{box-sizing: border-box;}
        body{
            background-color: #F2F6F9;
            color: #345181;
            font-family: monospace;
            font-size: 1.2em;
            line-height: 1.7em;
        }
        .container{
            max-width: 650px;
            margin: auto;
        }
        .timer{
            box-shadow: 0 0 16px 0 #C7D1E8;
            padding: 0.5rem 1rem 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .timer--expired{
            background-color: #00000030;
            color: #fff;
        }
        .row{
            display: block;
        }
        .app-title{
            color: #0033FF;
        }
        input{
            width: 49%;
        }
        .hidden{
            display: none;
        }
        .timer-input-display{
            background-color: #00f;
        }
        button{
            background-color: #4285f4;
            color: #fff;
            padding: 0.5em 1em;
            border: none;
            box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.16), 0 2px 10px 0 rgba(0, 0, 0, 0.12);
            margin: 5px;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .button:hover {
            opacity: 0.8;
        }
        .button:disabled{
            opacity: 0.4;
        }
        .button--red {
            background-color: #ff3547;
            color: #fff;
        }
        .button--green {
            background-color: #00c851;
            color: #fff;
        }
        .button--yellow {
            background-color: #FFBB33;
            color: #fff;
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="app-title">
            <div class="column">
                <h1>BlueCountdown</h1>
            </div>
        </div>
        <div class="row timer">
            <div>
                <input type="text" id="page-url" style="width: 100%;" placeholder="generatingPageUrl" disabled><br>
            </div>
            <div>
                <button class="button" id="timer1-button--edit" onclick="copyUrl('timer1')">Copy to share</button>
            </div>
        </div>
        <div class="row timer actionbar">
            <button class="button" onclick="addNewTimer()">+ Add new countdown timer</button>
        </div>
        <div class="row timer hidden" id="timer-new">
            <div class="row timer-title-container">
                <span class="timer-title" id="timer1-title">
                    New Timer
                </span>
            </div>
            <div class="row" id="timer-new--input">
                <input type="text" id="timer-new-title--input" placeholder="Timer title" style="display: block;width: 100%;">
                <input type="time" id="timer-new-time--input" step="1">
                <input type="date" id="timer-new-date--input">
            </div>
            <div class="row">
                <button class="button button--green" id="timer-new-button--savenew" onclick="saveNewTimer('timer1')">Save</button>
                <button class="button button--yellow" id="timer-new-button--cancelnew" onclick="cancelNewTimer('timer1')">Cancel</button>
            </div>
        </div>
        <!-- <div class="row timer">
            <div class="row timer-title-container" id="timer1">
                <span class="timer-title" id="timer1-title">
                    timer1 title
                </span>
            </div>
            <div class="row" id="timer1--display">
                <span>Time Left:</span>
                <span id="timer1-display--text">wip</span>
            </div>
            <div class="row hidden" id="timer1--input">
                <input type="time" id="timer1-time--input" step="1">
                <input type="date" id="timer1-date--input">
            </div>
            <div class="row">
                <button class="button" id="timer1-button--edit" onclick="editTimer('timer1')">Edit</button>
                <button class="button" id="timer1-button--save" onclick="saveTimer('timer1')" disabled>Save</button>
                <button class="button" id="timer1-button--delete" onclick="deleteTimer('timer1')">Delete</button>
                <button class="button button--yellow" id="timer1-button--confirmdelete" onclick="confirmdeleteTimer('timer1')">Confirm Delete</button>
            </div>
        </div> -->
    </div>
    <div class="container" id="timer-container">

    <script>
        // http://127.0.0.1:5500/timers.html?data=[%22papel01503020300320%22,%22something%20else%2001503020210320%22]
        
        //set constants
        const updateInterval = 1000;
        var counter = 0;
        // var timers = ['papel01503020210320','something else 01503020210320'];
        var timers=[];
        var timerIds=[]

        //initialize variables and dom
        function initializeApp(){
            extractUrlData();
            generateDom();
            updateUrlDisplay();
        }
        initializeApp();
        
        //set countdown objects
        //logging
        var now = new Date();


        //automated functions
        window.setInterval(
            function(){
                updateAllCountdowns();

                //ToDo: remove debug stuff
                generateDateTimeObject('01503020210320');
            },
            updateInterval
        );

        function updateUrlDisplay(){
            let baseUrl = window.location.href.split('?')[0];
            //get encoded json
            console.log();
            let generatedUrl = baseUrl+'?data='+JSON.stringify(timers);
            document.getElementById('page-url').value=encodeURI(generatedUrl);
        }
        function copyUrl(){
            // enable the text field for copying
            document.getElementById('page-url').disabled=false;
            var copyText = document.getElementById('page-url');
            // Select the text field
            copyText.select();
            copyText.setSelectionRange(0, 99999); /*For mobile devices*/

            // Copy the text inside the text field
            document.execCommand("copy");
            // disable the text field
            document.getElementById('page-url').disabled=true;

            // Alert the copied text
            alert("Copied the text: " + copyText.value);
        }
        //extract timer-array data array from url
        function extractUrlData(){
            timers=JSON.parse(decodeURIComponent(getQueryVariable('data')));
        }


        function getQueryVariable(variable) {
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return (false);
        }


        function generateDom(){
            var timerContainer = document.getElementById('timer-container');
            timers.forEach(function(timerData){
                // generate timerId
                let timerId='timer'+counter;
                counter++;
                // push timer id to timerIds array
                timerIds.push(timerId);
                let timerTitle = timerData.slice(0, -14);
                //append timer to dom
                let timerDivHtml = '<div class="row timer" id="'+timerId+'"><div class="row timer-title-container">		<span class="timer-title" id="'+timerId+'-title">			'+timerTitle+'		</span>	</div>	<div class="row" id="'+timerId+'--display">		<span>Time Left:</span>		<span id="'+timerId+'-display--text">Processing...</span>	</div>	<div class="row hidden timer-input-display" id="'+timerId+'--input">		<input type="time" id="'+timerId+'-time--input" step="1">		<input type="date" id="'+timerId+'-date--input">	</div>	<div class="row">		<button class="button" id="'+timerId+'-button--edit" onclick="editTimer(\''+timerId+'\')">Edit</button>		<button class="button button--green" id="'+timerId+'-button--save" onclick="saveTimer(\''+timerId+'\')" disabled>Save</button> <button class="button button--yellow hidden" id="'+timerId+'-button--confirmdelete" onclick="confirmDeleteTimer(\''+timerId+'\')">Confirm Delete</button>     <button class="button hidden" id="'+timerId+'-button--canceldelete" onclick="cancelDeleteTimer(\''+timerId+'\')">Cancel Delete</button>		<button class="button button--red" id="'+timerId+'-button--delete" onclick="deleteTimer(\''+timerId+'\')">Delete</button>	</div></div>';
                let timerDomDiv = document.createElement('div');
                timerDomDiv.innerHTML=timerDivHtml;
                var timerContainer = document.getElementById('timer-container');
                timerContainer.appendChild(timerDomDiv);
                //set timer input data fields
                setInputDateTime(timerId,generateDateTimeObject(timerData.slice(-14)));
            });
        }


        function generateDateTimeObject(dateTimeString){
            //string format: hhmmssyyyyMMdd
            //indexes(position) hh:0 mm:2 ss:4 yyyy:6 MM:10 dd:12
            if(dateTimeString.length<14){
                alert('invalid inputs');
            }else{
                //using constructor: new Date(year,month,date,hour,minute,second)
                return new Date(dateTimeString.substr(6,4),
                                dateTimeString.substr(10,2),
                                dateTimeString.substr(12,2),
                                dateTimeString.substr(0,2),
                                dateTimeString.substr(2,2),
                                dateTimeString.substr(4,2)
                                );
                console.log(obj);
            }
        }

        function getInputDateTime(timerId){
            let timeInputId=timerId+'-time--input';
            let dateInputId=timerId+'-date--input';
            // document.getElementById(timeInputId).value
            let inputTime = document.getElementById(timeInputId).value;
            let inputDate = document.getElementById(dateInputId).value;
            return new Date(inputDate +' '+ inputTime);
        }


        function setInputDateTime(timerId,dateTimeValue){
            //ToDo: set to dynamic date
            let timeInputId=timerId+'-time--input';
            let dateInputId=timerId+'-date--input';
            let hh = ('0' + Math.floor((dateTimeValue % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).slice(-2);
            let mm = ('0' + Math.floor((dateTimeValue % (1000 * 60 * 60)) / (1000 * 60))).slice(-2);
            let ss = ('0' + Math.floor((dateTimeValue % (1000 * 60)) / 1000)).slice(-2);

            let yyyy = ('0' + dateTimeValue.getFullYear()).slice(-4);
            let MM = ('0' + (dateTimeValue.getMonth()+1)).slice(-2);
            let dd = ('0' + dateTimeValue.getDate()).slice(-2);
            
            // document.getElementById(timeInputId).value
            //time format: HH:mm:ss
            document.getElementById(timeInputId).value = hh+':'+mm+':'+ss;
            //date format: yyyy:MM:dd
            document.getElementById(dateInputId).value = yyyy+'-'+MM+'-'+dd;
            // document.getElementById(dateInputId).value;
        }


        function editTimer(timerId){
            //make input field visible
            document.getElementById(timerId+'--input').classList.remove("hidden");
            //enable save button
            document.getElementById(timerId+'-button--save').disabled=false;
        }


        function saveTimer(timerId){
            //make input field invisible
            document.getElementById(timerId+'--input').classList.add("hidden");
            //disable save button
            document.getElementById(timerId+'-button--save').disabled=true;
        }


        function updateAllCountdowns(){
            timerIds.forEach(function(id){
                updateCountdownById(id);
            });
        }


        function updateCountdownById(timerId){
            // console.log('updating:'+timerId);
            let countDownDateTime = getInputDateTime(timerId);
            let timerDisplayId = timerId+'-display--text';
            //get current date and time
            now = new Date().getTime();
            //calculate difference between now and target dateTime
            var timeDifference = countDownDateTime - now;
            // calculate dd,hh,mm,ss
            var days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
            var hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((timeDifference % (1000 * 60)) / 1000);

            //update result in element with target id
            document.getElementById(timerDisplayId).innerHTML = days + "d " + hours + "h " + minutes + "m " + seconds + "s ";
            
            //if timer is expired
            if (timeDifference < 0) {
                //clearInterval(x);
                document.getElementById(timerDisplayId).innerHTML = "EXPIRED";
                document.getElementById(timerId).classList.add("timer--expired");
            }else{
                document.getElementById(timerId).classList.remove("timer--expired");
            }
        }

        function deleteTimer(timerId){
            document.getElementById(timerId+'-button--delete').disabled=false;
            document.getElementById(timerId+'-button--delete').classList.add("hidden");
            document.getElementById(timerId+'-button--confirmdelete').classList.remove("hidden");
            document.getElementById(timerId+'-button--canceldelete').classList.remove("hidden");
        }
        function cancelDeleteTimer(timerId){
            //ToDo: remove from dom, remove from timer array
            document.getElementById(timerId+'-button--delete').classList.remove("hidden");
            document.getElementById(timerId+'-button--confirmdelete').classList.add("hidden");
            document.getElementById(timerId+'-button--canceldelete').classList.add("hidden");
        }

        function confirmDeleteTimer(timerId){
            //ToDo: remove from dom, remove from timer array
            // document.getElementById(timerId+'-button--delete').classList.remove("hidden");
            // document.getElementById(timerId+'-button--confirmdelete').classList.add("hidden");
            // document.getElementById(timerId+'-button--canceldelete').classList.add("hidden");
            document.getElementById(timerId).remove();
        }

        function addNewTimer(){
            document.getElementById('timer-new').classList.remove("hidden");
        }
        function cancelNewTimer(){
            document.getElementById('timer-new').classList.add("hidden");
        }
        function saveNewTimer(){
            document.getElementById('timer-new').classList.add("hidden");
            //ToDo: add stuff to ddata array
            initializeApp();
        }
        


    </script> 

</body>
